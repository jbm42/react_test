version: '3.9'
      
services:
  php:
    build:
      context: .              # include both php/ and node/
      dockerfile: php/Dockerfile
    ports:
      - "8080:80"
    volumes:
      - ./php/public:/var/www/html
    depends_on:
      - vue
      - svelte
      - next
      - react
      - solid
    environment:
      NODE_VUE_INTERNAL_URL: http://vue:5173
      NODE_SVELTE_INTERNAL_URL: http://svelte:5174
      NODE_NEXT_INTERNAL_URL: http://next:5175
      NODE_REACT_INTERNAL_URL: http://react:5176
      NODE_SOLID_INTERNAL_URL: http://solid:5178

  vue:
    build:
      context: ./node/vue
      dockerfile: Dockerfile
    expose:
      - "5173"
    volumes:
      - ./php/public/build:/assets-out
    environment:
      PORT: 5173
    healthcheck:
      test:
        [
          "CMD",
          "node",
          "-e",
          "fetch('http://localhost:5173/health').then(res => res.ok ? process.exit(0) : process.exit(1)).catch(() => process.exit(1))",
        ]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  svelte:
    build:
      context: ./node/svelte
      dockerfile: Dockerfile
    expose:
      - "5174"
    volumes:
      - ./php/public/build:/assets-out
    environment:
      PORT: 5174
    healthcheck:
      test:
        [
          "CMD",
          "node",
          "-e",
          "fetch('http://localhost:5174/health').then(res => res.ok ? process.exit(0) : process.exit(1)).catch(() => process.exit(1))",
        ]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  next:
    build:
      context: ./node/next
      dockerfile: Dockerfile
    expose:
      - "5175"
    volumes:
      - ./php/public/build:/assets-out
    environment:
      PORT: 5175
    healthcheck:
      test:
        [
          "CMD",
          "node",
          "-e",
          "fetch('http://localhost:5175/health').then(res => res.ok ? process.exit(0) : process.exit(1)).catch(() => process.exit(1))",
        ]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  react:
    build:
      context: ./node/react
      dockerfile: Dockerfile
    expose:
      - "5176"
    volumes:
      - ./php/public/build:/assets-out
    environment:
      PORT: 5176
    healthcheck:
      test:
        [
          "CMD",
          "node",
          "-e",
          "fetch('http://localhost:5176/health').then(res => res.ok ? process.exit(0) : process.exit(1)).catch(() => process.exit(1))",
        ]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  solid:
    build:
      context: ./node/solid
      dockerfile: Dockerfile
    expose:
      - "5178"
    volumes:
      - ./php/public/build:/assets-out
    environment:
      PORT: 5178
    healthcheck:
      test:
        [
          "CMD",
          "node",
          "-e",
          "fetch('http://localhost:5178/health').then(res => res.ok ? process.exit(0) : process.exit(1)).catch(() => process.exit(1))",
        ]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
