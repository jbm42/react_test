version: '3.9'
      
services:
  php:
    build:
      context: .              # include both php/ and node/
      dockerfile: php/Dockerfile
    ports:
      - "8080:80"
    volumes:
      - ./php/public:/var/www/html
    depends_on:
      - node
    environment:
      NODE_INTERNAL_URL: http://node:5173

  node:
    build:
      context: ./node
      dockerfile: Dockerfile
    expose:
      - "5173"
    healthcheck:
      test:
        [
          "CMD",
          "node",
          "-e",
          "fetch('http://localhost:5173/ssr').then(res => res.ok ? process.exit(0) : process.exit(1)).catch(() => process.exit(1))",
        ]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
